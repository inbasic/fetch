/* globals Fetch */

{
  const MIME_TYPES = {
    'text/html': 'html',
    'text/css': 'css',
    'text/xml': 'xml',
    'image/gif': 'gif',
    'image/jpeg': 'jpg',
    'application/x-javascript': 'js',
    'application/atom+xml': 'atom',
    'application/rss+xml': 'rss',
    'text/plain': 'txt',
    'text/javascript': 'js',
    'image/png': 'png',
    'image/tiff': 'tiff',
    'image/x-icon': 'ico',
    'image/x-ms-bmp': 'bmp',
    'image/svg+xml': 'svg',
    'image/webp': 'webp',
    'application/java-archive': 'jar',
    'application/msword': 'doc',
    'application/pdf': 'pdf',
    'application/postscript': 'ps',
    'application/rtf': 'rtf',
    'application/vnd.ms-excel': 'xls',
    'application/vnd.ms-powerpoint': 'ppt',
    'application/x-7z-compressed': '7z',
    'application/x-rar-compressed': 'rar',
    'application/x-shockwave-flash': 'swf',
    'application/x-xpinstall': 'xpi',
    'application/xhtml+xml': 'xhtml',
    'application/zip': 'zip',
    'application/octet-stream': 'bin',
    'audio/midi': 'midi',
    'audio/mpeg': 'mp3',
    'audio/ogg': 'ogg',
    'video/3gpp': '3gp',
    'video/mpeg': 'mpg',
    'video/quicktime': 'mov',
    'video/x-flv': 'flv',
    'video/x-mng': 'mng',
    'video/x-ms-asf': 'asf',
    'video/x-ms-wmv': 'wmv',
    'video/x-msvideo': 'avi',
    'video/mp4': 'mp4',
    'video/m4v': 'm4v'
  };
  // https://www.garykessler.net/library/file_sigs.html
  const MAGIC_BYTES = {
    'mp4': [
      4,
      ['66', '74', '79', '70', '4d', '53', '4e', '56'],
      ['66', '74', '79', '70', '69', '73', '6f', '6d']
    ],
    'm4v': [
      4,
      ['66', '74', '79', '70', '6d', '70', '34', '32']
    ],
    'gif': [
      0,
      ['47', '49', '46', '38', '37', '61'],
      ['47', '49', '46', '38', '39', '61']
    ],
    'jpg': [
      0,
      ['ff', 'd8', 'ff', 'db'],
      ['ff', 'd8', 'ff', 'e0', '?', '?', '4a', '46', '49', '46', '00', '01'],
      ['ff', 'd8', 'ff', 'e1', '?', '?', '45', '78', '69', '66', '00', '00']
    ],
    'rpm': [
      0,
      ['ed', 'ab', 'ee', 'db']
    ],
    'bin': [
      0,
      ['53', '50', '30', '31']
    ],
    'pdb': [
      0,
      ['00', '00', '00', '00', '00', '00', '00', '00', '00', '00', '00', '00', '00', '00', '00', '00', '00', '00', '00', '00', '00', '00', '00', '00']
    ],
    'dba': [
      0,
      ['be', 'ba', 'fe', 'ca']
    ],
    'dba2': [
      0,
      ['00', '01', '42', '44']
    ],
    'tda': [
      0,
      ['00', '01', '44', '54']
    ],
    'tda2': [
      0,
      ['00', '01', '00', '00']
    ],
    'ico': [
      0,
      ['00', '00', '01', '00']
    ],
    '3gp': [
      0,
      ['66', '74', '79', '70', '33', '67']
    ],
    'bac': [
      0,
      ['42', '41', '43', '4b', '4d', '49', '4b', '45', '44', '49', '53', '4b']
    ],
    'bz2': [
      0,
      ['42', '5a', '68']
    ],
    'tif': [
      0,
      ['49', '49', '2a', '00']
    ],
    'tiff': [
      0,
      ['4d', '4d', '00', '2a']
    ],
    'cr2': [
      0,
      ['49', '49', '2a', '00', '10', '00', '00', '00', '43', '52']
    ],
    'cin': [
      0,
      ['80', '2a', '5f', 'd7']
    ],
    'cin1': [
      0,
      ['52', '4e', '43', '01']
    ],
    'cin2': [
      0,
      ['52', '4e', '43', '02']
    ],
    'dpx': [
      0,
      ['53', '44', '50', '58']
    ],
    'dpx2': [
      0,
      ['58', '50', '44', '53']
    ],
    'exr': [
      0,
      ['76', '2f', '31', '01']
    ],
    'bpg': [
      0,
      ['42', '50', '47', 'fb']
    ],
    'ilbm': [
      0,
      ['46', '4f', '52', '4d', '?', '?', '?', '?', '49', '4c', '42', '4d']
    ],
    '8svx': [
      0,
      ['46', '4f', '52', '4d', '?', '?', '?', '?', '38', '53', '56', '58']
    ],
    'acbm': [
      0,
      ['46', '4f', '52', '4d', '?', '?', '?', '?', '41', '43', '42', '4d']
    ],
    'anbm': [
      0,
      ['46', '4f', '52', '4d', '?', '?', '?', '?', '41', '4e', '42', '4d']
    ],
    'anim': [
      0,
      ['46', '4f', '52', '4d', '?', '?', '?', '?', '41', '4e', '49', '4d']
    ],
    'faxx': [
      0,
      ['46', '4f', '52', '4d', '?', '?', '?', '?', '46', '41', '58', '58']
    ],
    'ftxt': [
      0,
      ['46', '4f', '52', '4d', '?', '?', '?', '?', '46', '54', '58', '54']
    ],
    'smus': [
      0,
      ['46', '4f', '52', '4d', '?', '?', '?', '?', '53', '4d', '55', '53']
    ],
    'cmus': [
      0,
      ['46', '4f', '52', '4d', '?', '?', '?', '?', '43', '4d', '55', '53']
    ],
    'yuvn': [
      0,
      ['46', '4f', '52', '4d', '?', '?', '?', '?', '59', '55', '56', '4e']
    ],
    'iff': [
      0,
      ['46', '4f', '52', '4d', '?', '?', '?', '?', '46', '41', '4e', '54']
    ],
    'aiff': [
      0,
      ['46', '4f', '52', '4d', '?', '?', '?', '?', '41', '49', '46', '46']
    ],
    'idx': [
      0,
      ['49', '4e', '44', '58']
    ],
    'lz': [
      0,
      ['4c', '5a', '49', '50']
    ],
    'zip': [
      0,
      ['50', '4b', '03', '04'],
      ['50', '4b', '05', '06'],
      ['50', '4b', '07', '08']
    ],
    'jar': [
      0,
      ['50', '4b', '03', '04'],
      ['50', '4b', '05', '06'],
      ['50', '4b', '07', '08']
    ],
    'odt': [
      0,
      ['50', '4b', '03', '04'],
      ['50', '4b', '05', '06'],
      ['50', '4b', '07', '08']
    ],
    'ods': [
      0,
      ['50', '4b', '03', '04'],
      ['50', '4b', '05', '06'],
      ['50', '4b', '07', '08']
    ],
    'odp': [
      0,
      ['50', '4b', '03', '04'],
      ['50', '4b', '05', '06'],
      ['50', '4b', '07', '08']
    ],
    'docx': [
      0,
      ['50', '4b', '03', '04'],
      ['50', '4b', '05', '06'],
      ['50', '4b', '07', '08']
    ],
    'xlsx': [
      0,
      ['50', '4b', '03', '04'],
      ['50', '4b', '05', '06'],
      ['50', '4b', '07', '08']
    ],
    'pptx': [
      0,
      ['50', '4b', '03', '04'],
      ['50', '4b', '05', '06'],
      ['50', '4b', '07', '08']
    ],
    'vsdx': [
      0,
      ['50', '4b', '03', '04'],
      ['50', '4b', '05', '06'],
      ['50', '4b', '07', '08']
    ],
    'apk': [
      0,
      ['50', '4b', '03', '04'],
      ['50', '4b', '05', '06'],
      ['50', '4b', '07', '08']
    ],
    'aar': [
      0,
      ['50', '4b', '03', '04'],
      ['50', '4b', '05', '06'],
      ['50', '4b', '07', '08']
    ],
    'rar': [
      0,
      ['52', '61', '72', '21', '1a', '07', '00'],
      ['52', '61', '72', '21', '1a', '07', '01', '00'],
      ['7f', '45', '4c', '46']
    ],
    'png': [
      0,
      ['89', '50', '4e', '47', '0d', '0a', '1a', '0a']
    ],
    'class': [
      0,
      ['ca', 'fe', 'ba', 'be'],
      ['ef', 'bb', 'bf'],
      ['fe', 'ed', 'fa', 'ce'],
      ['fe', 'ed', 'fa', 'cf'],
      ['ce', 'fa', 'ed', 'fe'],
      ['cf', 'fa', 'ed', 'fe'],
      ['ff', 'fe'],
      ['ff', 'fe'],
      ['ff', 'fe', '00', '00']
    ],
    'ps': [
      0,
      ['25', '21', '50', '53']
    ],
    'pdf': [
      0,
      ['25', '50', '44', '46']
    ],
    'asf': [
      0,
      ['30', '26', 'b2', '75', '8e', '66', 'cf', '11', 'a6', 'd9', '00', 'aa', '00', '62', 'ce', '6c']
    ],
    'wma': [
      0,
      ['30', '26', 'b2', '75', '8e', '66', 'cf', '11', 'a6', 'd9', '00', 'aa', '00', '62', 'ce', '6c']
    ],
    'wmv': [
      0,
      ['30', '26', 'b2', '75', '8e', '66', 'cf', '11', 'a6', 'd9', '00', 'aa', '00', '62', 'ce', '6c']
    ],
    'deploymentimage': [
      0,
      ['24', '53', '44', '49', '30', '30', '30', '31']
    ],
    'ogg': [
      0,
      ['4f', '67', '67', '53']
    ],
    'oga': [
      0,
      ['4f', '67', '67', '53']
    ],
    'ogv': [
      0,
      ['4f', '67', '67', '53']
    ],
    'psd': [
      0,
      ['38', '42', '50', '53']
    ],
    'wav': [
      0,
      ['52', '49', '46', '46', '?', '?', '?', '?', '57', '41', '56', '45']
    ],
    'avi': [
      0,
      ['52', '49', '46', '46', '?', '?', '?', '?', '41', '56', '49', '20']
    ],
    'mp3': [
      0,
      ['ff', 'fb'],
      ['49', '44', '33']
    ],
    'iso': [
      0,
      ['43', '44', '30', '30', '31']
    ],
    'flac': [
      0,
      ['66', '4c', '61', '43']
    ],
    'mid': [
      0,
      ['4d', '54', '68', '64']
    ],
    'midi': [
      0,
      ['4d', '54', '68', '64']
    ],
    'doc': [
      0,
      ['d0', 'cf', '11', 'e0', 'a1', 'b1', '1a', 'e1']
    ],
    'xls': [
      0,
      ['d0', 'cf', '11', 'e0', 'a1', 'b1', '1a', 'e1']
    ],
    'ppt': [
      0,
      ['d0', 'cf', '11', 'e0', 'a1', 'b1', '1a', 'e1']
    ],
    'msg': [
      0,
      ['d0', 'cf', '11', 'e0', 'a1', 'b1', '1a', 'e1']
    ],
    'dex': [
      0,
      ['64', '65', '78', '0a', '30', '33', '35', '00']
    ],
    'vmdk': [
      0,
      ['4b', '44', '4d']
    ],
    'crx': [
      0,
      ['43', '72', '32', '34']
    ],
    'fh8': [
      0,
      ['41', '47', '44', '33']
    ],
    'cwk': [
      0,
      ['05', '07', '00', '00', '42', '4f', '42', '4f', '05', '07', '00', '00', '00', '00', '00', '00', '00', '00', '00', '00', '00', '01'],
      ['06', '07', 'e1', '00', '42', '4f', '42', '4f', '06', '07', 'e1', '00', '00', '00', '00', '00', '00', '00', '00', '00', '00', '01']
    ],
    'toast': [
      0,
      ['45', '52', '02', '00', '00', '00'],
      ['8b', '45', '52', '02', '00', '00', '00']
    ],
    'dmg': [
      0,
      ['78', '01', '73', '0d', '62', '62', '60']
    ],
    'xar': [
      0,
      ['78', '61', '72', '21']
    ],
    'dat': [
      0,
      ['50', '4d', '4f', '43', '43', '4d', '4f', '43']
    ],
    'nes': [
      0,
      ['4e', '45', '53', '1a']
    ],
    'tar': [
      0,
      ['75', '73', '74', '61', '72', '00', '30', '30'],
      ['75', '73', '74', '61', '72', '20', '20', '00']
    ],
    'tox': [
      0,
      ['74', '6f', '78', '33']
    ],
    'mlv': [
      0,
      ['4d', '4c', '56', '49']
    ],
    'windowsupdate': [
      0,
      ['44', '43', '4d', '01', '50', '41', '33', '30']
    ],
    '7z': [
      0,
      ['37', '7a', 'bc', 'af', '27', '1c']
    ],
    'xz': [
      0,
      ['fd', '37', '7a', '58', '5a', '00', '00']
    ],
    'tar.xz': [
      0,
      ['fd', '37', '7a', '58', '5a', '00', '00']
    ],
    'lz2': [
      0,
      ['04', '22', '4d', '18']
    ],
    'cab': [
      0,
      ['4d', '53', '43', '46']
    ],
    'mkv': [
      0,
      ['1a', '45', 'df', 'a3']
    ],
    'mka': [
      0,
      ['1a', '45', 'df', 'a3']
    ],
    'mks': [
      0,
      ['1a', '45', 'df', 'a3']
    ],
    'mk3d': [
      0,
      ['1a', '45', 'df', 'a3']
    ],
    'webm': [
      0,
      ['1a', '45', 'df', 'a3']
    ],
    'dcm': [
      0,
      ['44', '49', '43', '4d']
    ],
    'xml': [
      0,
      ['3c', '3f', '78', '6d', '6c', '20']
    ],
    'wasm': [
      0,
      ['00', '61', '73', '6d']
    ],
    'lep': [
      0,
      ['cf', '84', '01']
    ],
    'swf': [
      0,
      ['43', '57', '53'],
      ['46', '57', '53']
    ],
    'deb': [
      0,
      ['21', '3c', '61', '72', '63', '68', '3e']
    ],
    'rtf': [
      0,
      ['7b', '5c', '72', '74', '66', '31']
    ],
    'mpg': [
      0,
      ['00', '00', '01', 'ba']
    ],
    'mpeg': [
      0,
      ['00', '00', '01', 'bx'],
      ['47'],
      ['00', '00', '01', 'b3']
    ]
  };
  class GFetch extends Fetch {
    guess(ua) {
      const hex = [...ua].map(h => ('00' + h.toString(16)).substr(-2));
      for (const [extension, [offset, ...buffers]] of Object.entries(MAGIC_BYTES)) {
        for (const b of buffers) {
          for (let i = 0; i < b.length && i < ua.byteLength; i += 1) {
            if (b[i] !== '?') {
              if (hex[i + offset] !== b[i]) {
                break;
              }
              else if (hex[i + offset] === b[i] && i === b.length - 1) {
                this.meta['guessed-extension'] = extension;
                for (const [mime, ext] of Object.entries(MIME_TYPES)) {
                  if (ext === extension) {
                    this.meta['guessed-mime'] = mime;
                    break;
                  }
                }
                return super.guess();
              }
            }
          }
        }
      }
      return super.guess();
    }
  }
  window.Fetch = GFetch;
}
